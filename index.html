<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Presentation</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="loader">
        <div class="spinner"></div>
        <div id="loader-text">Loading Presentation...</div>
        <div id="error-log" style="color:red; margin-top:10px; font-size:12px;"></div>
    </div>

    <div id="camera">
        <div id="strip"></div>
    </div>

    <div id="ui-layer">
        <div id="controls">
            <button class="btn" id="btn-prev"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
            <span id="slide-count">-- / --</span>
            <button class="btn" id="btn-next"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></button>
            <div class="divider"></div>
            <button class="btn" id="btn-overview"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></button>
        </div>
    </div>

    <script type="module">
        import { Marpit } from 'https://esm.sh/@marp-team/marpit@2.5.0';

        const els = {
            loader: document.getElementById('loader'),
            error: document.getElementById('error-log'),
            camera: document.getElementById('camera'),
            strip: document.getElementById('strip'),
            btnPrev: document.getElementById('btn-prev'),
            btnNext: document.getElementById('btn-next'),
            btnOverview: document.getElementById('btn-overview'),
            count: document.getElementById('slide-count')
        };

        const state = {
            slides: [],
            index: 0,
            overview: false
        };

        const PARAMS = { w: 1280, h: 720, scaleFit: 0.85, scaleOverview: 0.22 };

        async function init() {
            try {
                // 1. Fetch
                const res = await fetch('slides.md');
                if(!res.ok) throw new Error('Could not find slides.md');
                const md = await res.text();

                // 2. Marpit
                const marpit = new Marpit({ 
                    inlineSVG: false, 
                    container: false 
                });

                // 3. Theme - Load 'default' for minimal base
                try {
                    const tRes = await fetch('https://unpkg.com/@marp-team/marp-core/themes/default.css');
                    if(tRes.ok) {
                        let css = await tRes.text();
                        if(!css.includes('/* @theme')) css = '/* @theme default */\n' + css;
                        marpit.themeSet.add(css);
                    }
                } catch(e) { console.warn('Theme load failed'); }

                // 4. Render
                const { html, css } = marpit.render(md);
                
                // Inject Theme CSS
                const style = document.createElement('style');
                style.textContent = css;
                document.body.appendChild(style);

                // 5. Process Slides
                const temp = document.createElement('div');
                temp.innerHTML = html;
                const sections = Array.from(temp.querySelectorAll('section'));
                
                if(sections.length === 0) throw new Error('No slides found');

                sections.forEach((section, i) => {
                    const frame = document.createElement('div');
                    frame.className = 'slide-frame';
                    
                    // --- Post-Processing for Layouts ---
                    // Detect "bg right" images (simulated)
                    // Marpit renders images as <img src="..." alt="bg right...">
                    const bgImg = section.querySelector('img[alt*="bg right"]');
                    if (bgImg) {
                        section.classList.add('split-layout');
                        
                        // Create wrappers
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'content-side';
                        
                        const imgDiv = document.createElement('div');
                        imgDiv.className = 'image-side';
                        
                        // Move all non-image children to content
                        while (section.firstChild) {
                            section.firstChild.remove(); // Remove from section
                        }
                        
                        // Parse original content (this is tricky because we removed it)
                        // Actually, we should iterate children.
                        // Better approach:
                        // 1. Clone img
                        const newImg = bgImg.cloneNode(true);
                        imgDiv.appendChild(newImg);
                        
                        // 2. Move everything else to contentDiv
                        // Re-fetch children from temp source or just use what we have? 
                        // Wait, we cleared section.
                        // Let's retry:
                        
                        // Reset section children
                        // We need to re-render or just be careful.
                    }
                    // -----------------------------------
                    
                    frame.appendChild(section);

                    // --- Post-Processing Phase 2: DOM Manipulation inside Frame ---
                    handleLayout(section);

                    frame.addEventListener('click', () => {
                        if(state.overview) { toggleOverview(false); goto(i); }
                        else if(state.index !== i) goto(i);
                    });

                    els.strip.appendChild(frame);
                    state.slides.push(frame);
                });

                // 6. Start
                goto(0);
                window.addEventListener('resize', updateCamera);
                setupInputs();
                
                setTimeout(() => {
                    els.loader.style.opacity = '0';
                    setTimeout(()=>els.loader.style.display='none', 500);
                }, 400);

            } catch(e) {
                els.error.textContent = e.message;
            }
        }

        function handleLayout(section) {
            // Find an image intended for split layout
            const imgs = Array.from(section.querySelectorAll('img'));
            const splitImg = imgs.find(img => img.alt && img.alt.includes('bg right'));

            if (splitImg) {
                // Apply Split Layout
                section.classList.add('split-layout');

                // Create containers
                const contentSide = document.createElement('div');
                contentSide.className = 'content-side';
                
                const imageSide = document.createElement('div');
                imageSide.className = 'image-side';
                
                // Move the split image to image side
                imageSide.appendChild(splitImg);
                
                // Move everything else to content side
                // Note: NodeList is live, so we freeze it
                const children = Array.from(section.childNodes);
                children.forEach(child => {
                    if (child === splitImg) return; // Skip the image we moved
                    if (child === imageSide) return; // Skip our new container
                    if (child === contentSide) return;
                    contentSide.appendChild(child);
                });

                // Clear and Append
                section.appendChild(contentSide);
                section.appendChild(imageSide);
            }
        }

        function goto(i) {
            if(i < 0) i = 0;
            if(i >= state.slides.length) i = state.slides.length - 1;
            state.index = i;

            els.btnPrev.disabled = i === 0;
            els.btnNext.disabled = i === state.slides.length - 1;
            els.count.textContent = `${i+1} / ${state.slides.length}`;

            state.slides.forEach((s, idx) => {
                if(idx === i) s.classList.add('active');
                else s.classList.remove('active');
            });

            updateCamera();
        }

        function toggleOverview(force) {
            state.overview = (typeof force === 'boolean') ? force : !state.overview;
            updateCamera();
        }

        function updateCamera() {
            if(state.slides.length === 0) return;

            const winW = window.innerWidth;
            const winH = window.innerHeight;
            
            const fitScale = Math.min(winW / PARAMS.w, winH / PARAMS.h) * PARAMS.scaleFit;
            const scale = state.overview ? PARAMS.scaleOverview : fitScale;

            const activeSlide = state.slides[state.index];
            const cx = activeSlide.offsetLeft + (PARAMS.w / 2);
            const cy = PARAMS.h / 2;

            els.camera.style.transform = `scale(${scale}) translate(${-cx}px, ${-cy}px)`;
        }

        function setupInputs() {
            document.addEventListener('keydown', e => {
                if(e.key === 'ArrowRight' || e.key === ' ' || e.key === 'Enter') goto(state.index + 1);
                if(e.key === 'ArrowLeft') goto(state.index - 1);
                if(e.key === 'ArrowUp') toggleOverview(true);
                if(e.key === 'ArrowDown') toggleOverview(false);
                if(e.key === 'Escape') toggleOverview(false);
            });
            els.btnPrev.onclick = () => goto(state.index - 1);
            els.btnNext.onclick = () => goto(state.index + 1);
            els.btnOverview.onclick = () => toggleOverview();
        }

        init();
    </script>
</body>
</html>
