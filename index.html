<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Presentation</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="loader">
        <div>Loading Presentation...</div>
        <div id="error-log"></div>
    </div>

    <div id="camera">
        <div id="strip"></div>
    </div>

    <div id="ui-layer">
        <div id="controls">
            <button class="btn" id="btn-prev"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
            <span id="slide-count">-- / --</span>
            <button class="btn" id="btn-next"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></button>
            <div class="divider"></div>
            <button class="btn" id="btn-overview"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg></button>
        </div>
    </div>

    <script type="module">
        import { Marpit } from 'https://esm.sh/@marp-team/marpit@2.5.0';

        const els = {
            loader: document.getElementById('loader'),
            error: document.getElementById('error-log'),
            camera: document.getElementById('camera'),
            strip: document.getElementById('strip'),
            btnPrev: document.getElementById('btn-prev'),
            btnNext: document.getElementById('btn-next'),
            btnOverview: document.getElementById('btn-overview'),
            count: document.getElementById('slide-count')
        };

        const state = {
            slides: [],
            index: 0,
            overview: false
        };

        const PARAMS = { w: 1280, h: 720, scaleFit: 0.85, scaleOverview: 0.25 };

        async function init() {
            try {
                // 1. Fetch
                const res = await fetch('slides.md');
                if(!res.ok) throw new Error('Failed to load slides.md');
                const md = await res.text();

                // 2. Marpit (HTML Mode)
                const marpit = new Marpit({ 
                    inlineSVG: false, 
                    container: false // Crucial: Don't create a wrapper div
                });

                // 3. Theme
                try {
                    const tRes = await fetch('https://unpkg.com/@marp-team/marp-core/themes/gaia.css');
                    if(tRes.ok) {
                        let css = await tRes.text();
                        if(!css.includes('/* @theme')) css = '/* @theme gaia */\n' + css;
                        marpit.themeSet.add(css);
                    }
                } catch(e) { console.warn('Theme failed'); }

                // 4. Render
                const { html, css } = marpit.render(md);
                
                // Inject Theme CSS
                const style = document.createElement('style');
                style.textContent = css;
                document.body.appendChild(style);

                // 5. Build
                const temp = document.createElement('div');
                temp.innerHTML = html;
                const sections = Array.from(temp.querySelectorAll('section'));

                if(sections.length === 0) throw new Error('No slides found');

                sections.forEach((section, i) => {
                    const frame = document.createElement('div');
                    frame.className = 'slide-frame';
                    frame.appendChild(section);
                    
                    frame.addEventListener('click', () => {
                        if(state.overview) { toggleOverview(false); goto(i); }
                        else if(state.index !== i) goto(i);
                    });

                    els.strip.appendChild(frame);
                    state.slides.push(frame);
                });

                // 6. Start
                goto(0);
                window.addEventListener('resize', updateCamera);
                setupInputs();
                
                setTimeout(() => {
                    els.loader.style.opacity = '0';
                    setTimeout(() => els.loader.style.display = 'none', 500);
                }, 200);

            } catch(e) {
                els.error.textContent = e.message;
            }
        }

        function goto(i) {
            if(i < 0) i = 0;
            if(i >= state.slides.length) i = state.slides.length - 1;
            state.index = i;

            els.btnPrev.disabled = i === 0;
            els.btnNext.disabled = i === state.slides.length - 1;
            els.count.textContent = `${i+1} / ${state.slides.length}`;

            state.slides.forEach((s, idx) => {
                if(idx === i) s.classList.add('active');
                else s.classList.remove('active');
            });

            updateCamera();
        }

        function toggleOverview(force) {
            state.overview = (typeof force === 'boolean') ? force : !state.overview;
            updateCamera();
        }

        function updateCamera() {
            if(state.slides.length === 0) return;

            const winW = window.innerWidth;
            const winH = window.innerHeight;
            
            const fitScale = Math.min(winW / PARAMS.w, winH / PARAMS.h) * PARAMS.scaleFit;
            const scale = state.overview ? PARAMS.scaleOverview : fitScale;

            const activeSlide = state.slides[state.index];
            const cx = activeSlide.offsetLeft + (PARAMS.w / 2);
            const cy = PARAMS.h / 2;

            els.camera.style.transform = `scale(${scale}) translate(${-cx}px, ${-cy}px)`;
        }

        function setupInputs() {
            document.addEventListener('keydown', e => {
                if(e.key === 'ArrowRight' || e.key === ' ' || e.key === 'Enter') goto(state.index + 1);
                if(e.key === 'ArrowLeft') goto(state.index - 1);
                if(e.key === 'ArrowUp') toggleOverview(true);
                if(e.key === 'ArrowDown') toggleOverview(false);
                if(e.key === 'Escape') toggleOverview(false);
            });
            els.btnPrev.onclick = () => goto(state.index - 1);
            els.btnNext.onclick = () => goto(state.index + 1);
            els.btnOverview.onclick = () => toggleOverview();
        }

        init();
    </script>
</body>
</html>
